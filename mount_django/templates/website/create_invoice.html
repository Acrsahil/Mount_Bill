{% extends "layout.html" %}
{% load static %}

{% block title %}Create Invoice - InvoicePro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/create_invoice.css' %}">
<script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block content %}
{% include "website/modal/add_product_modal.html" %}


<div class="create-invoice-page" id="createInvoicePage">
    <div class="page-header">
        <div class="header-content">
            {% if mode == 'purchase' %}
            <h1 id="create_purchase_invoice"><i class="fas fa-file-invoice-dollar"></i> Create Purchase Bill</h1>
            {% else %}
            <h1 id="create_new_invoice"><i class="fas fa-file-invoice-dollar"></i> Create New Invoice</h1>
            {% endif %}
            <button class="text-white-600 hover:text-gray-800 p-2 rounded-full hover:bg-gray-200 transition" id="cancelInvoiceBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="page-content">
        <!-- Three column row for invoice details -->
        <div class="form-row-3">
            <div class="left-group">
               <div class="form-group" style="position: relative;">
                <label for="clientName">Client Name</label>
                <input type="text" id="clientName" class="form-control client-search-input" 
                       placeholder="Type client name (Tab to complete)...">
                <div class="search-hint" id="client-search-hint" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; z-index: 1000; width: 100%;">
                    <!-- Client suggestions will appear here -->
                </div>
            </div>
            </div>
            <div class="right-column">
            {% if mode == 'purchase' %}
            <div class = "form-group" id="billNoHeader">
                <label for="billNumber" id="billNo">Bill No</label>
                <input type="text" id="billNumber" class="form-control" value="Bill-001" readonly>
            </div>
             <div class="form-group" id="purchaseBillDate">
                <label for="purchaseDate">Invoice Date</label>
                <input type="date" id="purchaseDate" class="form-control" value="">
            </div>
            {% else %}
            <div class="form-group"  id="invoiceNoHeader">
                <label for="invoiceNumber">Invoice Number</label>
                <input type="text" id="invoiceNumber" class="form-control" value="INV-001" readonly>
            </div>
            <div class="form-group" id="invoiceCreationDate">
                <label for="invoiceDate">Invoice Date</label>
                <input type="date" id="invoiceDate" class="form-control" value="">
            </div>
           
            {% endif %}

        </div>
        </div>
             
        <div class="invoice-items">
            <div class="invoice-items-header">
                <h4>Invoice Items</h4>
            </div>
            
            <table class="invoice-items-table">
                <thead>
                    <tr>
                        <th>S.N</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Discount</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                    <!-- Invoice items will be added here -->
                </tbody>
                 <tfoot>
        <tr id="subtotalRow">
             <!-- Add Item Button -->
            <td colspan="3"><button class="add-item-btn" id="addItemBtn">
                <i class="fas fa-plus"></i> Add Item
            </button></td>
            <td class="subtotal-label">Subtotal:</td>
            <td id="subtotalDiscount" class="subtotal-value">Rs.0.00</td>
            <td id="subtotalAmounts" class="subtotal-value">Rs.0.00</td>
            <td></td>
        </tr>
    </tfoot>
            </table>
        </div>
        <!-- Discount, Tax and additional section-->
       <div class="charges" id="totalCharges">
    <div class="invoice-items">
        <div class="notes-charges-wrapper">

            <!-- LEFT -->
            <div id="additionalNotes"></div>

            <!-- RIGHT -->
            <div class="form-group" id="additionalChargesWrapper">

                <div id="discountContainer"></div>
                <div id="taxContainer"></div>
                <div id="additionalInputsContainer"></div>

                <!-- Buttons MUST be inside right column -->
                <div class="button-row">
                    <button type="button" id="addnoteBtn">+Add notes</button>
                    <button type="button" id="addDiscountBtn">+Add discount</button>
                    <button type="button" id="addTaxBtn">+Add Tax</button>
                    <button type="button" id="addChargeBtn">+Add Additional Charge</button>

                </div>

            </div>

        </div>
    </div>
</div>
  
                <!-- Totals Section -->
     <div class='totals-section' id="totalSection">
    <div class="invoice-totals-compact">
        <div class="total-column">
            <div class="field-row">
                <label for="totalAmount">Total:</label>
                <input type='text' id="totalAmount" placeholder="Rs.0.00">
            </div>
            <div class="field-row">
                <label class= "checkbox-label"><input type="checkbox" id="checkAmount">Received Amount:</label>
                <input type="number" id="receivedAmount" placeholder="Rs. ">
            </div>
            <div class="field-row balance-due" id="balanceDueAmount">
                <label for="balance-due">Balance Due:</label>
                <input type="text" id="balanceDue" placeholder="Rs. ">
            </div>
            <div class="field-row">
                <label for="payment">Payment Mode:</label>
                <select name="payment" id="payment">
                    <option value="Cash">Cash</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>
        </div>
    </div>
</div>

            
        
        
        <div class="page-footer">
            <button class="btn btn-light" id="cancelInvoiceBtnBottom">Cancel</button>
            <button class="btn btn-primary" style="display:none;"  id="updateInvoiceBtn">Update Invoice</button>
            {% if mode == 'purchase' %}
            <button class="btn btn-primary" id="savePurchaseBtn">Save Purchase</button>
            {% else %}
            <button class="btn btn-primary" id="saveInvoiceBtn">Save Invoice</button>
            {%endif%}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    const pageMode = "{{mode}}";
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const clientId = urlParams.get('clientId');

    if (clientId) {
        // fetch client info from backend
        const res = await fetch(`/dashboard/clients-info/${clientId}/`);
        const data = await res.json();

        // populate the clientName field
        const clientNameInput = document.getElementById('clientName');
        if (clientNameInput) {
            clientNameInput.value = data.client_name;
        }
    }
  
});
</script>
<script>
// Simple and safe data structure
window.djangoData = {
    products: {{ product|safe }},
    product_cat: {{ product_cat|safe }},
    clients: {{ customer|safe }},
    invoices: {{ invoices|safe }},
    csrfToken: "{{ csrf_token }}",
    active_tab: "{{ active_tab|default:'invoices' }}"
};
</script>

<script>
// SAFETY CHECK - Add this right before loading create_invoice.js
if (typeof window.djangoData === 'undefined') {
    window.djangoData = {
        products: [],
        product_cat: [],
        clients: [],
        invoices: {{ invoices|safe }},
        csrfToken: "{{ csrf_token }}",
        active_tab: "{{ active_tab|default:'invoices' }}"
    };
}
</script>

<script>const csrfToken = "{{ csrf_token }}";</script>
<script type="module" src="{% static 'js/create_invoice.js' %}"></script>
<script type="module" src="{% static 'js/purchase.js' %}"></script>


{% endblock %}
